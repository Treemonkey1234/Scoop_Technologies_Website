"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4236],{1621:(e,t,o)=>{o.d(t,{R2:()=>c,friendsAPI:()=>l,zl:()=>u});let a=async e=>{console.error("\uD83D\uDD0D AUTH ERROR:",e),console.log("\uD83D\uDD0D AUTH ERROR: Clearing all authentication data"),["user","authToken","accessToken","scoopUserId","scoopProfile","isNewUser","currentWalkthroughStep","walkthroughInProgress","auth0.is.authenticated","auth0.user","auth0.access_token","auth0.id_token","auth0.expires_at"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)}),sessionStorage.clear(),document.cookie.split(";").forEach(e=>{let[t]=e.trim().split("=");t&&(t.includes("auth")||t.includes("user")||t.includes("token"))&&(document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"),document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=").concat(window.location.hostname,";"))});for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);t&&(t.includes("auth")||t.includes("user")||t.includes("token"))&&localStorage.removeItem(t)}return"/signin"!==window.location.pathname&&(console.log("\uD83D\uDD0D AUTH ERROR: Redirecting to signin page"),window.location.href="/signin"),!1},s="https://coral-app-tjel2.ondigitalocean.app/api/v1";function r(){let e=[localStorage.getItem("authToken"),localStorage.getItem("accessToken"),sessionStorage.getItem("authToken"),sessionStorage.getItem("accessToken")].find(e=>e&&e.length>0);if(e)return console.log("\uD83D\uDD0D API: Found auth token from storage"),e;for(let e of document.cookie.split(";")){let[t,o]=e.trim().split("=");if("authToken"===t&&o)return console.log("\uD83D\uDD0D API: Found auth token from cookies"),decodeURIComponent(o)}return console.log("\uD83D\uDD0D API: No auth token found"),null}async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o="".concat(s).concat(e),n={"Content-Type":"application/json"},i=r();i?(n.Authorization="Bearer ".concat(i),console.log("\uD83D\uDD0D API: Adding Authorization header for",e)):console.log("\uD83D\uDD0D API: No auth token available for",e);let c={...t,headers:{...n,...t.headers}};console.log("\uD83D\uDD0D API Request:",{url:o,method:c.method||"GET",hasAuthHeader:!!n.Authorization,endpoint:e});try{let t=await fetch(o,c);if(console.log("\uD83D\uDD0D API Response:",{url:o,status:t.status,statusText:t.statusText,endpoint:e}),!t.ok){let e=Error("API request failed: ".concat(t.status," ").concat(t.statusText));throw e.status=t.status,(401===t.status||403===t.status)&&a(e),e}let s=await t.json();return console.log("\uD83D\uDD0D API Success:",{url:o,data:s?"received":"no data",endpoint:e}),s}catch(t){throw console.error("\uD83D\uDD0D API request error:",{url:o,error:t instanceof Error?t.message:"Unknown error",endpoint:e}),t}}let i={async getCurrentUser(){try{return(await n("/users/me")).user}catch(e){return console.error("Error fetching current user:",e),null}},createUser:async e=>(await n("/users",{method:"POST",body:JSON.stringify(e)})).user,updateUser:async(e,t)=>(await n("/users/".concat(e),{method:"PUT",body:JSON.stringify(t)})).user,getUserById:async e=>(await n("/users/".concat(e))).user,async searchUsers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return(await n("/users/search?q=".concat(encodeURIComponent(e),"&limit=").concat(t))).users}},c={login:async e=>await n("/auth/login",{method:"POST",body:JSON.stringify(e)}),signup:async e=>await n("/auth/signup",{method:"POST",body:JSON.stringify(e)}),async verifySession(){try{return{user:(await n("/users/me")).user,valid:!0}}catch(e){return{user:null,valid:!1}}}},l={getFriends:async()=>(await n("/friends")).friends,async addFriend(e){await n("/friends",{method:"POST",body:JSON.stringify({friend_id:e})})},async removeFriend(e){await n("/friends/".concat(e),{method:"DELETE"})},getFriendRequests:async()=>(await n("/friends/requests")).requests,async acceptFriendRequest(e){await n("/friends/requests/".concat(e,"/accept"),{method:"POST"})},async rejectFriendRequest(e){await n("/friends/requests/".concat(e,"/reject"),{method:"POST"})}},u={async syncLocalAuthWithBackend(){try{let e=localStorage.getItem("user"),t=localStorage.getItem("authToken");if(!e||!t)return{success:!1};let o=await c.verifySession();if(o.valid&&o.user)return localStorage.setItem("user",JSON.stringify(o.user)),{success:!0,user:o.user};return{success:!1}}catch(e){return console.error("Error syncing local auth with backend:",e),{success:!1}}},async migrateLocalDataToBackend(){try{let e=localStorage.getItem("user"),t=localStorage.getItem("authToken");if(!e||!t)return{success:!0,migrated:!1};let o=JSON.parse(e);if((await c.verifySession()).valid)return{success:!0,migrated:!1};let a=await i.createUser({auth0UserId:o.sub||"local_".concat(Date.now()),email:o.email,name:o.name,avatar:o.picture});return localStorage.setItem("user",JSON.stringify(a)),{success:!0,migrated:!0}}catch(e){return console.error("Error migrating local data to backend:",e),{success:!1,migrated:!1}}}};{let e=window.fetch;window.fetch=async function(t,o){let a="string"==typeof t?t:t.toString();if(a.includes(s)||a.includes("coral-app-tjel2.ondigitalocean.app")){let e=r(),t=new Headers(null==o?void 0:o.headers);if(!e||(null==o?void 0:o.headers)&&o.headers.Authorization?e||console.log("\uD83D\uDD0D FETCH INTERCEPTOR: No auth token available for",a):(console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Adding auth header to",a),t.set("Authorization","Bearer ".concat(e))),a.includes("coral-app-tjel2.ondigitalocean.app")){let e=null,o=localStorage.getItem("user");if(o)try{let t=JSON.parse(o);e=t.sub||t.auth0_user_id}catch(e){console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Failed to parse user data")}if(!e){let t=localStorage.getItem("auth0UserData");if(t)try{e=JSON.parse(t).sub}catch(e){console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Failed to parse Auth0 data")}}if(!e){let t=document.cookie.split("; ").find(e=>e.startsWith("auth0UserData="));if(t)try{e=JSON.parse(decodeURIComponent(t.split("=")[1])).sub}catch(e){console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Failed to parse Auth0 cookie data")}}e?(console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Adding Auth0 user ID header:",e),t.set("x-auth0-user-id",e)):console.log("\uD83D\uDD0D FETCH INTERCEPTOR: No Auth0 user ID found for",a)}o={...o,headers:t}}return e.call(window,t,o)},console.log("\uD83D\uDD0D FETCH INTERCEPTOR: Global fetch interceptor installed")}},1858:(e,t,o)=>{o.d(t,{Ke:()=>n,Oz:()=>s,X2:()=>i,cW:()=>r});let a="admin_account_override";function s(e){let t={userId:999,accountType:e,timestamp:Date.now()};localStorage.setItem(a,JSON.stringify(t)),console.log("\uD83D\uDCBE CLIENT ADMIN OVERRIDE: Stored override:",t)}function r(){try{let e=localStorage.getItem(a);if(!e)return null;let t=JSON.parse(e);if((Date.now()-t.timestamp)/36e5>24)return localStorage.removeItem(a),null;return console.log("\uD83D\uDCCB CLIENT ADMIN OVERRIDE: Retrieved override:",t),t}catch(e){return console.error("❌ CLIENT ADMIN OVERRIDE: Error parsing stored override:",e),localStorage.removeItem(a),null}}function n(e){var t;if(!e||!(null==e?void 0:e.id)||(t=e.id,!1))return e;let o=r();return o?(console.log("\uD83D\uDD27 CLIENT ADMIN OVERRIDE: Applying override to user object:",o),{...e,account_type:o.accountType,subscription_status:"free"===o.accountType?"none":"active"}):e}function i(e){return!0}},4236:(e,t,o)=>{o.d(t,{A:()=>i});var a=o(2115),s=o(5695),r=o(9002),n=o(1858);let i=()=>{let[e,t]=(0,a.useState)({isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1}),[o,i]=(0,a.useState)(!0),[c,l]=(0,a.useState)(null),u=(0,s.useRouter)(),d=(0,a.useRef)(!1),g=(0,a.useRef)(0),h=(0,a.useRef)(0),m=(0,a.useCallback)(async()=>{if("true"===sessionStorage.getItem("isLoggingOut")){console.log("\uD83D\uDD0D AUTH DEBUG: Logout in progress, skipping auth check"),t({isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1}),i(!1);return}let e=Date.now();if(d.current||e-g.current<1e3)return void console.log("\uD83D\uDD0D AUTH DEBUG: Auth check skipped - already in progress or too recent");if(h.current>5){console.warn("\uD83D\uDD0D AUTH DEBUG: Max auth checks reached, forcing unauthenticated state"),t({isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1,error:"Too many auth checks"}),i(!1);return}try{d.current=!0,g.current=e,h.current++,i(!0),console.log("\uD83D\uDD0D AUTH DEBUG: Starting authentication check..."),await new Promise(e=>setTimeout(e,100));try{let e=await fetch("/api/auth/status"),o=await e.json();if(console.log("\uD83D\uDD0D AUTH DEBUG: Server auth status:",o),o.isAuthenticated){let e=(0,n.Ke)(o.user);t({isAuthenticated:!0,user:e,authMethod:o.authMethod,sessionExpiry:o.sessionExpiry,needsOnboarding:!1}),i(!1),d.current=!1;return}}catch(e){console.log("\uD83D\uDD0D AUTH DEBUG: Could not fetch server auth status:",e)}let o=await (0,r.oI)();console.log("\uD83D\uDD0D AUTH DEBUG: Unified auth state:",o);let a={...o,user:o.user?(0,n.Ke)(o.user):o.user};t(e=>JSON.stringify(e)!==JSON.stringify(a)?(console.log("\uD83D\uDD0D AUTH DEBUG: Auth state changed, updating"),a):(console.log("\uD83D\uDD0D AUTH DEBUG: Auth state unchanged, skipping update"),e))}catch(a){let e;console.error("Auth check failed:",a);let o="session";a instanceof TypeError&&a.message.includes("fetch")?(o="network",e="Check your internet connection and try again"):a instanceof Error&&a.message.includes("config")?(o="config",e="Contact support - configuration issue detected"):a instanceof Error&&a.message.includes("validation")&&(o="validation",e="Please sign in again to refresh your session"),l({type:o,message:a instanceof Error?a.message:"Authentication check failed",recoveryAction:e}),t({isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1,error:a instanceof Error?a.message:"Unknown error"})}finally{i(!1),d.current=!1}},[]);(0,a.useEffect)(()=>{let e=setTimeout(()=>{o&&(console.log("\uD83D\uDD0D AUTH DEBUG: Auth check timeout, forcing completion"),i(!1),d.current=!1)},3e3);return m(),()=>clearTimeout(e)},[]);let p=async e=>{try{if(i(!0),"auth0"===e.method)return await (0,r.wT)(e.connection||"google-oauth2",e.returnTo),{success:!0};{if(!e.phoneNumber||!e.password)return{success:!1,error:"Phone number and password are required"};let t=await (0,r.Gr)({phoneNumber:e.phoneNumber,password:e.password});if(t.success)return await m(),{success:!0};return{success:!1,error:t.error}}}catch(e){return console.error("Login error:",e),{success:!1,error:e instanceof Error?e.message:"Login failed"}}finally{i(!1)}},T=async e=>{try{i(!0);let t=await (0,r.bM)(e);if(t.success)return await m(),{success:!0};return{success:!1,error:t.error}}catch(e){return console.error("Signup error:",e),{success:!1,error:e instanceof Error?e.message:"Signup failed"}}finally{i(!1)}},f=async()=>{try{i(!0),await (0,r.ri)()}catch(e){console.error("Logout error:",e)}finally{i(!1)}},S=async()=>{await m()};return{authState:e,isLoading:o,isAuthenticated:e.isAuthenticated,user:e.user,authMethod:e.authMethod,needsOnboarding:e.needsOnboarding,error:e.error,authError:c,login:p,signup:T,logout:f,refreshAuth:S,requireAuth:()=>!!o||!!e.isAuthenticated||(console.log("\uD83D\uDD0D AUTH DEBUG: requireAuth - redirecting to signin"),u.push("/signin"),!1),requireOnboarding:()=>!!o||!e.isAuthenticated||!e.needsOnboarding||(console.log("\uD83D\uDD0D AUTH DEBUG: requireOnboarding - redirecting to onboarding"),u.push("/onboarding"),!1),clearAuthError:()=>l(null),checkAuth:m}}},9002:(e,t,o)=>{o.d(t,{oI:()=>u,wT:()=>h,Gr:()=>d,ri:()=>m,D5:()=>p,bM:()=>g,CN:()=>T});var a=o(1621);class s{generateSessionId(){return"debug_"+Math.random().toString(36).substr(2,9)}log(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.enabled)return;let o=new Date().toISOString(),a={timestamp:o,sessionId:this.sessionId,message:e,...t};console.group("\uD83D\uDD10 AUTH DEBUG: ".concat(e)),console.log("Time:",o),console.log("Data:",t),console.log("Full Entry:",a),console.groupEnd()}setupGlobalListeners(){let e=localStorage.setItem,t=localStorage.removeItem,o=localStorage.clear;localStorage.setItem=(t,o)=>((t.includes("token")||t.includes("auth")||t.includes("user"))&&this.log("\uD83D\uDCE6 LocalStorage SET",{key:t,value:o.substring(0,50)+"..."}),e.call(localStorage,t,o)),localStorage.removeItem=e=>((e.includes("token")||e.includes("auth")||e.includes("user"))&&this.log("\uD83D\uDDD1️ LocalStorage REMOVE",{key:e}),t.call(localStorage,e)),localStorage.clear=()=>(this.log("\uD83E\uDDF9 LocalStorage CLEAR ALL"),o.call(localStorage)),window.addEventListener("beforeunload",()=>{this.log("\uD83D\uDEAA Page unloading")}),window.addEventListener("load",()=>{this.log("\uD83D\uDCC4 Page loaded"),this.checkAuthState()}),window.addEventListener("hashchange",()=>{this.log("\uD83D\uDD17 Hash changed",{hash:window.location.hash})}),window.addEventListener("popstate",()=>{this.log("⬅️ Browser back/forward",{url:window.location.href})})}checkAuthState(){let e={localStorage_keys:Object.keys(localStorage).filter(e=>e.includes("token")||e.includes("auth")||e.includes("user")),cookies:document.cookie,userAgent:navigator.userAgent,url:window.location.href,referrer:document.referrer};["token","authToken","jwt","accessToken","user","userId"].forEach(t=>{let o=localStorage.getItem(t);o&&(e["localStorage_".concat(t)]=o.substring(0,50)+"...")}),this.log("\uD83D\uDD0D Current Auth State",e)}trackApiCall(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=Math.random().toString(36).substr(2,6);return this.log("\uD83C\uDF10 API CALL START [".concat(s,"]"),{url:e,method:t,headers:this.sanitizeHeaders(o),hasBody:!!a,bodyPreview:a?JSON.stringify(a).substring(0,100)+"...":null}),s}trackApiResponse(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.log("✅ API RESPONSE [".concat(e,"]"),{status:t.status,statusText:t.statusText,headers:this.sanitizeHeaders(Array.from(t.headers.entries()).reduce((e,t)=>{let[o,a]=t;return e[o]=a,e},{})),hasData:!!o,dataPreview:o?JSON.stringify(o).substring(0,100)+"...":null})}trackApiError(e,t){this.log("❌ API ERROR [".concat(e,"]"),{message:t.message,stack:t.stack,name:t.name})}trackLogin(e){this.log("\uD83D\uDD10 LOGIN ATTEMPT",{email:e.email||e.username,hasPassword:!!e.password,timestamp:new Date().toISOString()})}trackLoginSuccess(e){this.log("✅ LOGIN SUCCESS",{userId:e.id||e._id,email:e.email,timestamp:new Date().toISOString()}),this.checkAuthState()}trackLoginFailure(e){this.log("❌ LOGIN FAILURE",{error:e.message||e,timestamp:new Date().toISOString()})}trackLogout(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"manual";this.log("\uD83D\uDEAA LOGOUT",{reason:e,timestamp:new Date().toISOString()}),this.checkAuthState()}trackRouteChange(e,t){this.log("\uD83E\uDDED ROUTE CHANGE",{from:e,to:t,timestamp:new Date().toISOString()}),this.checkAuthState()}sanitizeHeaders(e){let t={...e};return Object.keys(t).forEach(e=>{(e.toLowerCase().includes("authorization")||e.toLowerCase().includes("token")||e.toLowerCase().includes("cookie"))&&(t[e]=t[e].substring(0,20)+"...")}),t}analyzeJWT(){let e=["token","jwt","authToken","accessToken"],t=null,o=null;for(let a of e){let e=localStorage.getItem(a);if(e&&e.length>0){if(e.includes(".")&&e.length>20){t=e,o=a;break}else if(e.length>10){t=e,o=a,this.log("⚠️ Token found but may not be JWT format",{key:a,tokenLength:e.length,hasDots:e.includes("."),tokenPreview:e.substring(0,20)+"..."});break}}}if(!t)return this.log("❌ JWT NOT FOUND",{checkedKeys:e,localStorageKeys:Object.keys(localStorage),cookies:document.cookie,localStorageContents:Object.fromEntries(e.map(e=>[e,localStorage.getItem(e)?"Present":"Not found"]))}),null;try{let e=t.split(".");if(3!==e.length)return this.log("⚠️ Token may not be JWT format",{token:t.substring(0,50)+"...",parts:e.length,storageKey:o}),{storageKey:o,token:t.substring(0,50)+"...",tokenLength:t.length,isValidJWT:!1,message:"Token found but not in JWT format"};let a=JSON.parse(atob(e[0])),s=JSON.parse(atob(e[1])),r=Math.floor(Date.now()/1e3),n={storageKey:o,header:a,payload:{...s,sub:s.sub?"user_"+s.sub.toString().slice(-4):void 0},signature:e[2].substring(0,20)+"...",issuedAt:s.iat?new Date(1e3*s.iat).toISOString():"unknown",expiresAt:s.exp?new Date(1e3*s.exp).toISOString():"unknown",currentTime:new Date(1e3*r).toISOString(),isExpired:s.exp?r>s.exp:"unknown",secondsUntilExpiry:s.exp?s.exp-r:"unknown",timeUntilExpiry:s.exp?this.formatTimeRemaining(s.exp-r):"unknown",isValidJWT:!0};return n.isExpired?this.log("⏰ JWT EXPIRED",n):"number"==typeof n.secondsUntilExpiry&&n.secondsUntilExpiry<300?this.log("⚠️ JWT EXPIRING SOON",n):this.log("✅ JWT VALID",n),n}catch(e){return this.log("❌ JWT DECODE ERROR",{error:e.message,token:t.substring(0,50)+"...",storageKey:o}),{storageKey:o,token:t.substring(0,50)+"...",tokenLength:t.length,isValidJWT:!1,error:e.message}}}formatTimeRemaining(e){return e<=0?"expired":e<60?"".concat(e,"s"):e<3600?"".concat(Math.floor(e/60),"m ").concat(e%60,"s"):"".concat(Math.floor(e/3600),"h ").concat(Math.floor(e%3600/60),"m")}debugCurrentState(){this.log("\uD83D\uDD0D MANUAL STATE CHECK"),this.checkAuthState();let e=this.analyzeJWT();e&&e.isValidJWT&&"isExpired"in e&&"boolean"==typeof e.isExpired&&(e.isExpired?this.log("⏰ JWT EXPIRED",e):"secondsUntilExpiry"in e&&"number"==typeof e.secondsUntilExpiry&&e.secondsUntilExpiry<300?this.log("⚠️ JWT EXPIRING SOON",e):this.log("✅ JWT VALID",e)),this.checkNodeJSIssues();let t=localStorage.getItem("token")||localStorage.getItem("authToken")||localStorage.getItem("jwt"),o=document.cookie.includes("session")||document.cookie.includes("token")||document.cookie.includes("auth");this.log("\uD83C\uDFAF Quick Auth Check",{hasToken:!!t,hasCookies:!!o,jwtInfo:e?"Found":"Not found"})}trackJWTApiCall(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=this.trackApiCall(e,t,o.headers,o.body),s=this.analyzeJWT();return s&&s.isValidJWT&&"isExpired"in s&&"boolean"==typeof s.isExpired&&s.isExpired&&this.log("⚠️ API CALL WITH EXPIRED JWT [".concat(a,"]"),{url:e,expiredBy:"secondsUntilExpiry"in s&&"number"==typeof s.secondsUntilExpiry?Math.abs(s.secondsUntilExpiry)+" seconds":"unknown"}),a}checkNodeJSIssues(){this.log("\uD83D\uDD0D NODE.JS JWT ISSUES CHECK",{userAgent:navigator.userAgent,origin:window.location.origin,corsHeaders:{"Access-Control-Allow-Origin":"check network tab","Access-Control-Allow-Credentials":"check network tab","Access-Control-Allow-Headers":"check network tab"}});let e=localStorage.getItem("token")||localStorage.getItem("jwt");e&&this.log("\uD83D\uDCE4 EXPECTED REQUEST HEADERS",{Authorization:"Bearer ".concat(e.substring(0,20),"..."),"Content-Type":"application/json",note:"Verify these appear in Network tab"})}setupImmediateTracking(){let e=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(t,o,a){return"click"===t||"submit"===t||"change"===t?e.call(this,t,function(e){var a;window.authDebugger.log("\uD83D\uDDB1️ EVENT TRIGGERED: ".concat(t.toUpperCase()),{element:e.target.tagName,id:e.target.id,className:e.target.className,innerText:null==(a=e.target.innerText)?void 0:a.substring(0,50),href:e.target.href,action:e.target.action});let s=window.authDebugger.analyzeJWT();try{let a=o.call(this,e);return setTimeout(()=>{let o=window.authDebugger.analyzeJWT();s&&!o?window.authDebugger.log("\uD83D\uDEA8 JWT DISAPPEARED AFTER EVENT!",{event:t,element:e.target.tagName,beforeToken:s.storageKey,afterToken:"GONE"}):s&&o&&s.payload.exp!==o.payload.exp&&window.authDebugger.log("\uD83D\uDD04 JWT CHANGED AFTER EVENT",{event:t,element:e.target.tagName})},100),a}catch(o){throw window.authDebugger.log("❌ EVENT ERROR: ".concat(t),{error:o.message,element:e.target.tagName}),o}},a):e.call(this,t,o,a)}}setupPageStateTracking(){document.addEventListener("visibilitychange",()=>{document.hidden?this.log("\uD83D\uDC41️ PAGE HIDDEN"):(this.log("\uD83D\uDC41️ PAGE VISIBLE"),this.analyzeJWT())}),window.addEventListener("focus",()=>{this.log("\uD83C\uDFAF WINDOW FOCUSED"),this.analyzeJWT()}),window.addEventListener("blur",()=>{this.log("\uD83D\uDE34 WINDOW BLURRED")}),window.addEventListener("storage",e=>{if(e.key&&(e.key.includes("token")||e.key.includes("auth"))){var t,o;this.log("\uD83D\uDD04 STORAGE CHANGED BY ANOTHER TAB",{key:e.key,oldValue:(null==(t=e.oldValue)?void 0:t.substring(0,50))+"...",newValue:(null==(o=e.newValue)?void 0:o.substring(0,50))+"...",url:e.url})}})}setupFetchTracking(){let e=window.fetch;window.fetch=async function(t,o){let a=t.toString(),s=o||{},r=s.method||"GET",n=localStorage.getItem("token"),i=window.authDebugger.trackJWTApiCall(a,r,s);window.authDebugger.log("\uD83C\uDF10 INTERCEPTED FETCH [".concat(i,"]"),{url:a,method:r,hasToken:!!n,hasAuthHeader:!!(s.headers&&"object"==typeof s.headers&&(s.headers.Authorization||s.headers.authorization))});try{let s=await e.call(window,t,o),r=s.clone(),c=null;try{c=await r.json()}catch(e){try{c=await r.text()}catch(e){c="Could not read response"}}i&&window.authDebugger.trackApiResponse(i,s,c);let l=localStorage.getItem("token");return n&&!l&&window.authDebugger.log("\uD83D\uDEA8 TOKEN CLEARED AFTER FETCH!",{url:a,status:s.status,callId:i}),401===s.status&&(window.authDebugger.log("\uD83D\uDD10 401 UNAUTHORIZED RESPONSE",{url:a,responseData:c,willClearToken:!0}),setTimeout(()=>{localStorage.getItem("token")||window.authDebugger.log("✅ CONFIRMED: Token cleared after 401")},50)),s}catch(e){throw i&&window.authDebugger.trackApiError(i,e),e}}}constructor(e=!0){this.enabled=e,this.sessionId=this.generateSessionId(),this.enabled&&(this.log("\uD83D\uDD0D Auth Debugger initialized",{sessionId:this.sessionId}),this.setupGlobalListeners(),this.setupImmediateTracking(),this.setupPageStateTracking(),this.setupFetchTracking())}}let r=new s(!1);r&&(window.authDebugger=r),r&&(window.debugJWT=()=>r.analyzeJWT(),window.debugAuth=()=>r.debugCurrentState(),window.checkNodeIssues=()=>r.checkNodeJSIssues()),r&&(console.log("\uD83D\uDD10 Enhanced JWT Debugger loaded!"),console.log("Commands: debugJWT(), debugAuth(), checkNodeIssues()"),console.log("\uD83C\uDFAF When you click the button that logs you out, watch the console!"));var n=o(9509);n.env.AUTH0_DOMAIN,n.env.AUTH0_CLIENT_ID,n.env.AUTH0_CLIENT_SECRET,n.env.AUTH0_SECRET,n.env.AUTH0_BASE_URL,n.env.AUTH0_ISSUER_BASE_URL||n.env.AUTH0_DOMAIN;var i=o(9509);let c=async()=>{try{var e,t,o;let a=await fetch("/api/user"),s=await a.json();if(!s.session)return{isValid:!1};if(s.authMethod&&"auth0"!==s.authMethod)return console.log("\uD83D\uDD0D AUTH DEBUG: Session is not Auth0, skipping Auth0 check"),{isValid:!1};let r=s.session;if(r.expiresAt&&r.expiresAt<Date.now())return{isValid:!1,error:"Session expired"};let n={id:r.sub,name:r.name||"User",username:(null==(e=r.email)?void 0:e.split("@")[0])||(null==(t=r.name)?void 0:t.split(" ")[0])||"user",email:r.email||"",picture:r.picture||"",sub:r.sub,authMethod:"auth0",accessToken:r.accessToken};try{let e=await fetch("".concat("https://coral-app-tjel2.ondigitalocean.app","/api/v1/users/me"),{headers:{"x-auth0-user-id":r.sub,"x-auth0-email":r.email||"","x-auth0-name":r.name||"","x-auth0-picture":r.picture||""}});if(e.ok){let t=(await e.json()).user;n.scoopUserId=null==(o=t.id)?void 0:o.toString(),n.phone=t.phone,n.phone_verified=t.phone_verified,n.email_verified=t.email_verified,n.username=t.username||n.username,n.name=t.name||n.name,n.bio=t.bio,n.location=t.location,n.joinDate=t.joinDate,n.socialLinks=t.socialLinks,n.avatar=t.avatar,console.log("\uD83D\uDD0D AUTH USER DATA PRIORITIZATION:",{auth0Name:r.name,backendName:t.name,finalName:n.name,auth0Username:n.username,backendUsername:t.username,finalUsername:n.username})}else console.log("\uD83D\uDD0D AUTH DEBUG: Backend user profile fetch failed with status:",e.status)}catch(e){console.error("Failed to fetch backend user profile:",e)}try{await fetch("/api/admin/users?action=log-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n.id,email:n.email,name:n.name,auth_method:"auth0",session_data:{sub:n.sub,accessToken:n.accessToken}})})}catch(e){console.error("Failed to log Auth0 session to admin system:",e)}return{isValid:!0,user:n,expiresAt:r.expiresAt}}catch(e){return console.error("Auth0 session check failed:",e),{isValid:!1,error:e instanceof Error?e.message:"Unknown error"}}},l=async()=>{try{var e;let t=localStorage.getItem("authToken");if(!t)return console.log("\uD83D\uDD0D AUTH DEBUG: No auth token found in localStorage"),{isValid:!1};console.log("\uD83D\uDD0D AUTH DEBUG: Validating backend session with server");let o=await a.R2.verifySession();if(!o.valid||!o.user)return console.log("\uD83D\uDD0D AUTH DEBUG: Backend session validation failed - clearing local data"),localStorage.removeItem("authToken"),localStorage.removeItem("accessToken"),localStorage.removeItem("user"),localStorage.removeItem("scoopUserId"),sessionStorage.removeItem("authToken"),sessionStorage.removeItem("accessToken"),sessionStorage.removeItem("user"),{isValid:!1,error:"Session validation failed"};console.log("\uD83D\uDD0D AUTH DEBUG: Backend session validated successfully");let s={id:o.user.id.toString(),name:o.user.name,username:o.user.username||(null==(e=o.user.name)?void 0:e.split(" ")[0])||"user",email:o.user.email,picture:o.user.avatar_url,sub:o.user.auth0_user_id,authMethod:"backend",authToken:t,scoopUserId:o.user.id.toString(),phone:o.user.phone,phone_verified:o.user.phone_verified,email_verified:o.user.email_verified};return{isValid:!0,user:s,expiresAt:Date.now()+864e5}}catch(e){return console.error("Backend session check failed:",e),localStorage.removeItem("authToken"),localStorage.removeItem("accessToken"),localStorage.removeItem("user"),localStorage.removeItem("scoopUserId"),sessionStorage.removeItem("authToken"),sessionStorage.removeItem("accessToken"),sessionStorage.removeItem("user"),{isValid:!1,error:e instanceof Error?e.message:"Unknown error"}}},u=async()=>{try{let e=await c();if(e.isValid&&e.user){let t=!!(e.user.scoopUserId&&e.user.username&&e.user.phone),o=!!(e.user.scoopUserId&&e.user.username&&e.user.phone);return console.log("\uD83D\uDD0D AUTH0 USER ONBOARDING CHECK:",{scoopUserId:!!e.user.scoopUserId,username:!!e.user.username,phone:!!e.user.phone,hasOnboarding:t,hasCompleteBackendProfile:o,needsOnboarding:!o}),{isAuthenticated:!0,user:e.user,authMethod:"auth0",sessionExpiry:e.expiresAt||null,needsOnboarding:!o}}let t=await l();if(t.isValid&&t.user){let e=!!(t.user.username&&t.user.phone);return{isAuthenticated:!0,user:t.user,authMethod:"backend",sessionExpiry:t.expiresAt||null,needsOnboarding:!e}}return console.log("\uD83D\uDD0D AUTH DEBUG: No valid server session found, user not authenticated"),localStorage.removeItem("authToken"),localStorage.removeItem("accessToken"),localStorage.removeItem("user"),localStorage.removeItem("scoopUserId"),sessionStorage.removeItem("authToken"),sessionStorage.removeItem("accessToken"),sessionStorage.removeItem("user"),{isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1}}catch(e){return console.error("Unified auth state check failed:",e),localStorage.removeItem("authToken"),localStorage.removeItem("accessToken"),localStorage.removeItem("user"),localStorage.removeItem("scoopUserId"),sessionStorage.removeItem("authToken"),sessionStorage.removeItem("accessToken"),sessionStorage.removeItem("user"),{isAuthenticated:!1,user:null,authMethod:null,sessionExpiry:null,needsOnboarding:!1,error:e instanceof Error?e.message:"Unknown error"}}},d=async e=>{try{null==r||r.trackLogin(e);let t=await a.R2.login(e),o={id:t.user.id.toString(),name:t.user.name,username:t.user.username,email:t.user.email,picture:t.user.avatar_url,sub:t.user.auth0_user_id,authMethod:"backend",authToken:t.token,scoopUserId:t.user.id.toString(),phone:t.user.phone,phone_verified:t.user.phone_verified,email_verified:t.user.email_verified};localStorage.setItem("user",JSON.stringify(o)),localStorage.setItem("authToken",t.token),localStorage.setItem("scoopUserId",o.scoopUserId);try{console.log("\uD83D\uDD0D BACKEND LOGIN: Attempting to sync auth state with server...");let e=await fetch("/api/auth/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:o,authToken:t.token})});if(e.ok){let t=await e.json();console.log("\uD83D\uDD0D BACKEND LOGIN: Auth sync successful:",t),console.log("\uD83D\uDD0D BACKEND LOGIN: Sync headers:",Object.fromEntries(e.headers.entries()))}else throw console.error("\uD83D\uDD0D BACKEND LOGIN: Auth sync failed with status:",e.status),Error("Auth sync failed")}catch(s){console.error("\uD83D\uDD0D BACKEND LOGIN: Failed to sync auth state:",s),console.log("\uD83D\uDD0D BACKEND LOGIN: Using fallback cookie setting...");let e=encodeURIComponent(JSON.stringify(o)),a="path=/; max-age=".concat(86400,"; SameSite=Lax");document.cookie="user=".concat(e,"; ").concat(a),document.cookie="authToken=".concat(t.token,"; ").concat(a),console.log("\uD83D\uDD0D BACKEND LOGIN: Fallback cookie setting completed")}console.log("\uD83D\uDD0D BACKEND LOGIN: Successfully logged in with backend"),await new Promise(e=>setTimeout(e,100)),null==r||r.trackLoginSuccess(o),null==r||r.analyzeJWT();try{await fetch("/api/admin/users?action=log-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:o.id,email:o.email,name:o.name,auth_method:"backend",session_data:{scoopUserId:o.scoopUserId}})}),await fetch("/api/admin/users?action=log-backend-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:o.id,email:o.email,name:o.name,scoop_user_id:parseInt(o.scoopUserId||"0")})})}catch(e){console.error("Failed to log session to admin system:",e)}return{success:!0,user:o}}catch(e){return null==r||r.trackLoginFailure(e),console.error("\uD83D\uDD0D BACKEND LOGIN: Login failed:",e),{success:!1,error:e instanceof Error?e.message:"Login failed"}}},g=async e=>{try{let t=await a.R2.signup(e),o={id:t.user.id.toString(),name:t.user.name,username:t.user.username,email:t.user.email,picture:t.user.avatar_url,sub:t.user.auth0_user_id,authMethod:"backend",authToken:t.token,scoopUserId:t.user.id.toString(),phone:t.user.phone,phone_verified:t.user.phone_verified,email_verified:t.user.email_verified};localStorage.setItem("user",JSON.stringify(o)),localStorage.setItem("authToken",t.token),localStorage.setItem("scoopUserId",o.scoopUserId);try{await fetch("/api/auth/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:o,authToken:t.token})}),console.log("\uD83D\uDD0D BACKEND SIGNUP: Auth sync successful")}catch(s){console.error("Failed to sync auth state:",s);let e=encodeURIComponent(JSON.stringify(o)),a="path=/; max-age=".concat(86400,"; SameSite=Lax");document.cookie="user=".concat(e,"; ").concat(a),document.cookie="authToken=".concat(t.token,"; ").concat(a),console.log("\uD83D\uDD0D BACKEND SIGNUP: Fallback cookie setting completed")}console.log("\uD83D\uDD0D BACKEND SIGNUP: Successfully signed up with backend");try{await fetch("/api/admin/users?action=log-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:o.id,email:o.email,name:o.name,auth_method:"backend",session_data:{scoopUserId:o.scoopUserId}})}),await fetch("/api/admin/users?action=log-backend-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:o.id,email:o.email,name:o.name,scoop_user_id:parseInt(o.scoopUserId||"0")})})}catch(e){console.error("Failed to log session to admin system:",e)}return{success:!0,user:o}}catch(e){if(console.error("\uD83D\uDD0D BACKEND SIGNUP: Signup failed:",e),e instanceof Error){if(e.message.includes("409"))return{success:!1,error:"Account already exists. This phone number or email is already registered. Please try signing in instead, or use a different phone number/email."};else if(e.message.includes("400"))return{success:!1,error:"Invalid signup data. Please check your information and try again."};else if(e.message.includes("500"))return{success:!1,error:"Server error. Please try again later."}}return{success:!1,error:e instanceof Error?e.message:"Signup failed. Please try again."}}},h=async(e,t)=>{try{console.log("\uD83D\uDD0D AUTH0 LOGIN: Starting Auth0 login process"),console.log("\uD83D\uDD0D AUTH0 LOGIN: Connection:",e),console.log("\uD83D\uDD0D AUTH0 LOGIN: Return to:",t);let o={returnTo:t||window.location.pathname,connection:e,authMethod:"auth0"},a=i.env.NEXT_PUBLIC_AUTH0_DOMAIN||"dev-av6q4m54qqcs5n00.us.auth0.com",s=i.env.NEXT_PUBLIC_AUTH0_CLIENT_ID||"5uKzDSRavv2WqTOvDnDqsh2pGvHQ759C",r=i.env.NEXT_PUBLIC_AUTH0_BASE_URL||"https://app.scoopsocials.com",n=new URL("https://".concat(a,"/authorize"));n.searchParams.set("response_type","code"),n.searchParams.set("client_id",s),n.searchParams.set("redirect_uri","".concat(r,"/api/auth/callback")),n.searchParams.set("scope","openid profile email"),n.searchParams.set("state",btoa(JSON.stringify(o))),n.searchParams.set("connection",e),window.location.href=n.toString()}catch(e){throw console.error("Auth0 login error:",e),e}},m=async()=>{try{null==r||r.trackLogout("manual"),sessionStorage.setItem("isLoggingOut","true");let e=i.env.NEXT_PUBLIC_AUTH0_DOMAIN||"dev-av6q4m54qqcs5n00.us.auth0.com",t=i.env.NEXT_PUBLIC_AUTH0_CLIENT_ID||"5uKzDSRavv2WqTOvDnDqsh2pGvHQ759C",o=new URL("https://".concat(e,"/v2/logout"));o.searchParams.set("client_id",t),o.searchParams.set("returnTo","".concat(window.location.origin,"/signin")),console.log("\uD83D\uDD0D LOGOUT: Starting comprehensive auth cleanup"),["user","authToken","accessToken","scoopUserId","scoopProfile","isNewUser","currentWalkthroughStep","walkthroughInProgress","auth0.is.authenticated","auth0.user","auth0.access_token","auth0.id_token","auth0.expires_at"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)}),sessionStorage.clear(),["appSession","user","authToken","auth0UserData"].forEach(e=>{document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"),document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=").concat(window.location.hostname,";"),document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.").concat(window.location.hostname,";")}),document.cookie.split(";").forEach(e=>{let[t]=e.trim().split("=");t&&(t.includes("auth")||t.includes("user")||t.includes("token")||t.includes("session"))&&(document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"),document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=").concat(window.location.hostname,";"))});for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);t&&(t.includes("auth")||t.includes("user")||t.includes("token"))&&localStorage.removeItem(t)}console.log("\uD83D\uDD0D LOGOUT: Cleared all authentication data");try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){console.log("\uD83D\uDD0D LOGOUT: Server logout failed, continuing with client logout")}await new Promise(e=>setTimeout(e,100)),window.location.href="/signin"}catch(e){console.error("Logout error:",e),window.location.href="/signin"}},p=async()=>{try{console.log("\uD83D\uDD0D MIGRATION: Starting migration to backend...");let e=localStorage.getItem("user"),t=localStorage.getItem("authToken");if(!e||!t)return console.log("\uD83D\uDD0D MIGRATION: No local data to migrate"),{success:!0,migrated:!1};let o=await a.zl.migrateLocalDataToBackend();if(o.success&&o.migrated)return console.log("\uD83D\uDD0D MIGRATION: Successfully migrated local data to backend"),{success:!0,migrated:!0};if(o.success)return console.log("\uD83D\uDD0D MIGRATION: User already exists in backend, synced data"),{success:!0,migrated:!1};return console.log("\uD83D\uDD0D MIGRATION: Migration failed, keeping local data"),{success:!1,migrated:!1,error:"Migration failed"}}catch(e){return console.error("\uD83D\uDD0D MIGRATION: Error during migration:",e),{success:!1,migrated:!1,error:e instanceof Error?e.message:"Unknown error"}}},T=async e=>{try{console.log("\uD83D\uDD0D SMS SIGNUP: Creating account with SMS verification");let t=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await t.json();if(!t.ok)return console.error("\uD83D\uDD0D SMS SIGNUP: Signup failed:",o.message),{success:!1,error:o.message||"Signup failed"};{console.log("\uD83D\uDD0D SMS SIGNUP: Account created successfully");let e={id:o.user.id.toString(),name:o.user.name,username:o.user.username,email:o.user.email,picture:o.user.avatar_url,sub:o.user.auth0_user_id,authMethod:"sms",authToken:o.token,scoopUserId:o.user.id.toString(),phone:o.user.phone,phone_verified:o.user.phone_verified,email_verified:o.user.email_verified};return null==r||r.trackLoginSuccess(e),null==r||r.analyzeJWT(),{success:!0,user:e,needsVerification:o.needsVerification}}}catch(e){return console.error("\uD83D\uDD0D SMS SIGNUP: Error:",e),{success:!1,error:"An unexpected error occurred"}}}}}]);